---
title: "BEES3041_CoralDiversity_Bleaching"
author: "Sophie"
date: "7/19/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The class "Anthozoa" has more than 1.5 million data entries. It comprises 11 orders, namely "Actiniaria", "Alcyonacea", "Antipatharia", "Corallimorpharia", "Heliolitina", "Helioporarea", "Penicillaria", "Pennatulacea", "Scleractinia", "Spirularia" & "Zoantharia". However, not all of these orders are tropical corals.
Specifically, "Actiniaria", "Penicillaria" and "Spirularia" are sea anemones, "Pennatulacea" are sea pens, "Antipatharia" are deep sea corals and "Heliolitina"are fossils. Hence, all these 6 orders are neglected for this project. Only the following orders are considered: 
[1]  Alcyonacea: the soft corals
[2]  Corallimorpharia: tropical corals, closely related to Scleractinia
[3]  Helioporacea: colonial, stony corals
[4]  Scleractinia: stony corals & gorgonians
[5]  Zoantharia
The data from the above named orders is downloaded indivdially from gbif.org and saved on to the computer.

```{r Load libraries}
library(data.table)
library(sf)
library(fasterize)
library(dplyr)
library(maps)
library(maptools)
library(sp)
library(raster)
library(leaflet) # not sure if needed -> colorbar?
library(CoordinateCleaner)
library(rnaturalearth)
library(tidyverse)
library(ncdf4)
library(ggplot2)
```

The data that has been successfully saved on to the computer is now loaded into r studio.

```{r Load data}

coral_list <- list.files(pattern="order.*csv")

load_data <- function(data_list) {
   coral_data_list<-list()
   e<-1
   for (l in data_list) {
     coral_data_list[[e]] <- fread(l, select = c("species","decimalLongitude", "decimalLatitude", "speciesKey"))
     e=e+1
   }
   return(coral_data_list)
 }
 
coral_data <- load_data(coral_list)

```

In the different datasets, some records do not contain the coordinates whilst others lack the identification to species level. Since those records that lack the information about species ID and location are meaningless for the purpose of this project, this next step involves the removal of N.A.s in coordinates ("decimalLongitude" & "decimalLatitude") and "speciesKey".

Note: if longitude is missing, latitude is missing as well. Hence, no need to check for N.A.s in decimalLatitude

```{r Data cleaning}
 
 clean_data <- function(df) {
     filt_data <- filter(df,!is.na(decimalLongitude)&!is.na(speciesKey)) %>%
     list();
   } 

cleaned_list <- lapply(coral_data,FUN=clean_data)
```

Dataframes are often more easy to handle compared to lists. Therefore, the following function transforms lists into one big dataframe.

```{r}
list_to_df <- function(data_list) {
  comb_df <- data_list[[1]]
   for (l in 2:length(data_list)) {
     comb_df <- bind_rows(comb_df,data.frame(data_list[[l]]))
   }
  return(comb_df)
}
```

Plots of diversity hotspots per order, i.e. species richness for the different orders

```{r Raster & Mapping}

cleaned_df <- list_to_df(cleaned_list);

sea_coords <- function(df){
  coords_land <- clean_coordinates(df, lon = "decimalLongitude", lat = "decimalLatitude", species = "species", tests = c("seas"), value="clean")
  df_compared <- ((df$decimalLongitude %in% coords_land$decimalLongitude) & (df$decimalLatitude%in% coords_land$decimalLatitude) & (df$species %in% coords_land$species))
  new_coordinates <- filter(cleaned_df, !df_compared);
}

cleaned_coordinates <- sea_coords(cleaned_df);


map_coral <- function(list_clean){
  for (l in 1:length(list_clean)) {
    corpoints <- st_as_sf(data.frame(list_clean[[l]]), coords = c(x="decimalLongitude", y="decimalLatitude"))
     r <- raster(corpoints, res = 0.8)
     r <- rasterize(corpoints, r, field = "speciesKey", fun= function(x, ...) {length(unique(na.omit(x)))})
      #pdf(paste0(l,".pdf"))
     #as_mapper(c("world"))
     #map("world")
     plot(r)  # adds the worldmap to the raster on the same plot , add= TRUE
     #dev.off()
   }
}

map_coral(cleaned_list);


```

Mapping hotspots of all orders on one map

```{r Hotspot map of all coral species}

combine_all_coords <- function(list_all_orders) {
  c <-1
  coords_list <- list()
    for (l in 1:length(list_all_orders)){
       coords_list[[c]] <- st_as_sf((data.frame(list_all_orders[[l]])), coords = c(x="decimalLongitude", y="decimalLatitude"))
       c = c+1
    }  
  return(coords_list)
}

coords_all_sp <- list();
coords_all_sp <- combine_all_coords(cleaned_list);

df_all_coords <- coords_all_sp[[1]]
df_all_coords <- do.call('rbind',coords_all_sp);


r_all <- raster(coords_all_sp[[1]], res= 1.5)
r_all <- rasterize(df_all_coords, r_all, field = "speciesKey", fun= function(x, ...) {length(unique(na.omit(x)))})

r2<-r_all>100
pts<-data.frame(rasterToPoints(r_all,fun=function(x){x>100}))

world<-ne_countries(scale="medium",returnclass="sf")
ggplot(data=world)+geom_sf()+geom_point(data=pts,aes(x=x,y=y,color=layer))+scale_colour_gradientn(colours = c("#FFCCCC", "#FF9999","#FF6666","#CC3333", "#990000", "#660000"))

```

Coral bleaching susceptibility vs resistance

Different species of corals have different levels of tolerance with respect to fluctuating temperatures. Swain et al. (2016) have defined and standardized this variability in the form of a "Bleaching Response Index" (BRI). In total, they have defined BRIs for 

The data has been downloaded from the supplementary material provided by Swain et al. (2016). 
```{r BRI data}
BRI_data <- fread("BRI_taxon_Swain2016.csv", select = c("Taxon", "Taxon-BRI (Bleaching Response Index) (%)", "Number of records", "Std Deviation"))

BRI_data$`Taxon-BRI (Bleaching Response Index) (%)`<-as.numeric(gsub(",",".",BRI_data$`Taxon-BRI (Bleaching Response Index) (%)`))

BRI_data$`Std Deviation`<-as.numeric(gsub(",",".",BRI_data$`Std Deviation`))

clean_BRI_data <- filter(BRI_data, BRI_data$`Number of records` != "1" & BRI_data$`Std Deviation` != "") # remove records where standard deviation is zero and those where the number of records is only one


# filter out genus (character length = 1)
species_only <- function(taxa) {
  split_taxa <- list()
  length_taxa <- integer()
  for (i in 1:length(taxa)) {
    split_taxa <- strsplit(taxa[i]," ")
    length_taxa <- length(split_taxa[[1]])
      if (length_taxa == 1) {
        taxa[i] <- NA
      }
  }
  return(taxa)
}

clean_BRI_data$Taxon <- species_only(clean_BRI_data$Taxon);
clean_BRI_data <- na.omit(clean_BRI_data)
```

Standardized taxon-specifc Bleaching Response Index (BRIj) defined by Swain et al. (2016):
- Highly susceptible corals have a BRIj above 40%
- Highly resistant corals have a BRIj below 10%

```{r}
susceptible_corals <- clean_BRI_data %>% filter(`Taxon-BRI (Bleaching Response Index) (%)` > 40);
resistant_corals <- clean_BRI_data %>% filter(`Taxon-BRI (Bleaching Response Index) (%)` < 10);
```

Function that finds susceptible/resistant species in GBIF data set.

```{r}

# GBIF_susc <- filter(cleaned_df,cleaned_df$species %in% susceptible_corals$Taxon);
# GBIF_res <- filter(cleaned_df,cleaned_df$species %in% resistant_corals$Taxon);
GBIF_susc <- filter(df_all_coords, df_all_coords$species %in% susceptible_corals$Taxon);
GBIF_res <- filter(df_all_coords, df_all_coords$species %in% resistant_corals$Taxon);

# Susceptible species

# world_map <- map_data("world")
# ggplot(world_map, aes(x = long, y = lat, group = group)) +
#   geom_polygon(fill="lightgray", colour = "white") + geom_point(data = GBIF_susc, aes(x= GBIF_susc$decimalLongitude, y= GBIF_susc$decimalLatitude, group = NULL))
# 
# r_susc<- raster(GBIF_susc, res= 1.5)
# r_susc<- rasterize(GBIF_susc, r_susc, field = "speciesKey", fun= function(x, ...) {length(unique(na.omit(x)))})
# 
# pts_susc<-data.frame(rasterToPoints(r_susc,fun=function(x){x==28887}))
# 
# world<-ne_countries(scale="medium",returnclass="sf")
# ggplot(data=world)+geom_sf()+geom_point(data=pts_susc,aes(x=x,y=y,color="blue"))

### Plot of coral susceptibility
extent(r_all) <- extent(r_susc); # needed to get same resolution!!
r_susc <- raster(GBIF_susc[[1]], res= 1.5)
r_susc <- rasterize(GBIF_susc, r_susc, field = "speciesKey", fun= function(x, ...) {length(unique(na.omit(x)))})
pts_susc<-data.frame(rasterToPoints(r_susc,fun=function(x){x>10}))
r2<-r_all>100
world<-ne_countries(scale="medium",returnclass="sf")
ggplot(data=world)+geom_sf()+geom_point(data=pts_susc,aes(x=x,y=y,color=layer))+scale_colour_gradientn(colours = c("#FFCCCC", "#FF9999","#FF6666","#CC3333", "#990000", "#660000"))

```
Plot RELATIVE coral susceptibility

```{r}

relativate <- function(raster_resilience, raster_abundance) {
  rel_resil <- integer();
  r_rel <- raster();
  for (i in 1:ncol(raster_resilience)){
   for (j in 1:nrow(raster_resilience)) {
     rel_resil <- round(raster_resilience$layer/raster_abundance$layer)
     r_rel[i,j] <- rel_resil
   }
  }
  return(r_rel)
}

relative_susc <- relativate(r_susc, r_all);

r_rel_susc <- merge(r_all, r_susc, tolerance= 1.0, overlap= TRUE)
pts_rel_susc <- data.frame(rasterToPoints(r_rel_susc,fun=function(x){x>100}))

world<-ne_countries(scale="medium",returnclass="sf")
ggplot(data=world)+geom_sf()+geom_point(data=pts_rel_susc,aes(x=x,y=y,color=layer))+scale_colour_gradientn(colours = c("#FFCCCC", "#FF9999","#FF6666","#CC3333", "#990000", "#660000"))

r_tot_div <- raster(df_all_coords, res = 1.0)
r_tot_div <- rasterize(df_all_coords, r_tot_div, field = "speciesKey", fun= function(x, ...) {length(unique(na.omit(x)))})
plot(r_tot_div)

```

xy
```{r}
plot(r_tot_div > 200)
plot(r_susc > 25)
```
```{r}
cor_div <- raster(coords_all_sp[[1]], res= 1.5)
cor_div <- rasterize(df_all_coords, cor_div, field = "speciesKey", fun= function(x, ...) {length(unique(na.omit(x)))})
pts_cor_div <-data.frame(rasterToPoints(cor_div,fun=function(x){x>300}))

r_high_susc <- raster(GBIF_susc[1], res= 1.5)
r_high_susc <- rasterize(GBIF_susc, r_high_susc, field = "speciesKey", fun= function(x, ...) {length(unique(na.omit(x)))})
pts_high_susc<-data.frame(rasterToPoints(r_high_susc,fun=function(x){x>25}))

world<-ne_countries(scale="medium",returnclass="sf")
ggplot(data=world)+geom_sf()+geom_point(data=pts_cor_div,aes(x=x,y=y,color=layer))+scale_colour_gradientn(colours = c("#FFCCCC", "#FF9999","#FF6666","#CC3333", "#990000", "#660000")) + geom_point(data= pts_high_susc, aes(x=x,y=y, color=layer))
```

